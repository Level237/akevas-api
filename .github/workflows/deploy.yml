name: Deploy Laravel API

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: hostinger
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # On force le chemin absolu pour éviter les erreurs
            cd /home/${{ secrets.USERNAME }}/domains/akevas.com/public_html/api

            # Vérifier si on est au bon endroit avant de continuer
            if [ ! -f "artisan" ]; then
              echo "Erreur : Fichier artisan non trouvé dans $(pwd)"
              exit 1
            fi

            git pull origin main

            # S'assurer que les dossiers de cache existent
            mkdir -p storage/framework/{sessions,views,cache}
            mkdir -p storage/logs
            mkdir -p bootstrap/cache

            /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction

            # Application des permissions seulement si les dossiers existent
            chmod -R 775 storage bootstrap/cache
            
            php artisan config:cache
            php artisan route:cache